'use client';

import React, { useRef, useCallback, useMemo } from 'react';
import { motion, useInView } from 'framer-motion';
import Link from 'next/link';
import BeforeAfterSlider from '@/shared/ui/BeforeAfterSlider/BeforeAfterSlider';
import ArrowButton from '@/shared/ui/ArrowButton/ArrowButton';
import FeaturesSection from '@/shared/components/FeaturesSection/FeaturesSection';
import Section2 from './Section2';
import Section3 from './Section3';
import * as styles from './HairTransplantLayout.css';
import { vw, mvw } from '@/shared/styles/responsive.utils';
import { processDescription } from './utils';
import type { HairTransplantLayoutProps } from './types';

export default function HairTransplantLayout({
  heroTitle,
  heroTitleMobile,
  heroSubtitle,
  language = 'KR', // 기본값 설정
  isCrown = false, // 기본값 설정
  isHairline = false, // 기본값 설정
  heroDotPosition,
  heroBackground,
  heroIllustration = '/hair-transplant/hero-illustration.svg',
  heroIllustrationMobile = '/hair-transplant/mobile/hero-illustration-mobile.svg',
  heroIllustrationSize,
  heroIllustrationPosition,
  section1,
  section2,
  section3,
  beforeAfterData,
  beforeAfterButton,
  featuresTitle,
  featuresTitleMobile,
  featureCards,
  sidePreviewData,
  buttonCards,
  scarReduction = false,
  customMiddleSection,
}: HairTransplantLayoutProps) {
  const [isMobile, setIsMobile] = React.useState(false);
  const [isDesktopLarge, setIsDesktopLarge] = React.useState(false);

  const section1ImagesRef = useRef(null);
  const section1ImagesInView = useInView(section1ImagesRef, { once: true });
  const section2ImagesRef = useRef(null);
  const section2ImagesInView = useInView(section2ImagesRef, { once: true });
  const section3ImagesRef = useRef(null);
  const section3ImagesInView = useInView(section3ImagesRef, { once: true });

  // 화면 크기 체크 함수 - useCallback으로 메모이제이션
  const checkScreenSize = useCallback(() => {
    setIsMobile(window.innerWidth <= 1023);
    setIsDesktopLarge(window.innerWidth >= 1920);
  }, []);

  React.useEffect(() => {
    // 클라이언트에서만 미디어 쿼리 체크
    checkScreenSize();
    window.addEventListener('resize', checkScreenSize);

    return () => window.removeEventListener('resize', checkScreenSize);
  }, [checkScreenSize]);

  return (
    <>
      {/* Hero Section */}
      <section className={styles.HairTransplantHeroSection}>
        <div className={styles.HairTransplantHeroContainer}>
          {/* Hero Title - 중앙에 배치 */}
          <div className={styles.HairTransplantHeroTitleWrapper}>
            <div className={styles.HairTransplantHeroTitleContainer}>
              <h1 className={styles.HairTransplantHeroTitle}>
                <span
                  style={{
                    display: isMobile ? 'block' : 'flex',
                    alignItems: isMobile ? undefined : 'center',
                    justifyContent: isMobile ? undefined : 'flex-start',
                    position: heroDotPosition?.absolute ? 'relative' : undefined,
                  }}
                >
                  {isMobile ? (
                    <div
                      style={{
                        display: 'inline-block',
                        position: 'relative',
                      }}
                    >
                      <span style={{ display: 'inline' }}>{heroTitleMobile || heroTitle}</span>
                      <div
                        className={
                          heroDotPosition?.absolute
                            ? styles.HairTransplantHeroTitleDotAbsolute
                            : styles.HairTransplantHeroTitleDot
                        }
                        style={{
                          display: 'inline-block',
                          marginLeft: mvw(8),
                          verticalAlign: 'baseline',
                          position: 'relative',
                        }}
                      />
                    </div>
                  ) : (
                    <>
                      {heroTitle}
                      <div
                        className={
                          heroDotPosition?.absolute
                            ? styles.HairTransplantHeroTitleDotAbsolute
                            : styles.HairTransplantHeroTitleDot
                        }
                        style={
                          heroDotPosition?.absolute
                            ? {
                                // Use mobile values if mobile, fixed px for 1920px+, vw for medium screens
                                ...(isMobile && heroDotPosition.mobileTop !== undefined
                                  ? { top: mvw(heroDotPosition.mobileTop) }
                                  : heroDotPosition.top !== undefined
                                  ? {
                                      top: isDesktopLarge ? `${heroDotPosition.top}px` : vw(heroDotPosition.top),
                                    }
                                  : {}),
                                ...(isMobile && heroDotPosition.mobileRight !== undefined
                                  ? { right: mvw(heroDotPosition.mobileRight) }
                                  : heroDotPosition.right !== undefined
                                  ? {
                                      right: isDesktopLarge ? `${heroDotPosition.right}px` : vw(heroDotPosition.right),
                                    }
                                  : {}),
                                ...(isMobile && heroDotPosition.mobileBottom !== undefined
                                  ? {
                                      bottom: mvw(heroDotPosition.mobileBottom),
                                    }
                                  : heroDotPosition.bottom !== undefined
                                  ? {
                                      bottom: isDesktopLarge
                                        ? `${heroDotPosition.bottom}px`
                                        : vw(heroDotPosition.bottom),
                                    }
                                  : {}),
                                ...(isMobile && heroDotPosition.mobileLeft !== undefined
                                  ? { left: mvw(heroDotPosition.mobileLeft) }
                                  : heroDotPosition.left !== undefined
                                  ? {
                                      left: isDesktopLarge ? `${heroDotPosition.left}px` : vw(heroDotPosition.left),
                                    }
                                  : {}),
                              }
                            : undefined
                        }
                      />
                    </>
                  )}
                </span>
              </h1>
            </div>
          </div>
          {/* Hero Illustration - 왼쪽에 붙도록 (데스크탑용) */}
          <div
            className={styles.HairTransplantHeroIllustration}
            style={
              heroIllustrationSize || heroIllustrationPosition
                ? {
                    ...(heroIllustrationSize
                      ? {
                          width: isDesktopLarge
                            ? `${heroIllustrationSize.width}px`
                            : `${(heroIllustrationSize.width / 1920) * 100}vw`,
                          height: isDesktopLarge
                            ? `${heroIllustrationSize.height}px`
                            : `${(heroIllustrationSize.height / 1920) * 100}vw`,
                        }
                      : {}),
                    ...(heroIllustrationPosition
                      ? {
                          ...(heroIllustrationPosition.left !== undefined
                            ? {
                                left: isDesktopLarge
                                  ? `${heroIllustrationPosition.left}px`
                                  : `${(heroIllustrationPosition.left / 1920) * 100}vw`,
                              }
                            : {}),
                          ...(heroIllustrationPosition.right !== undefined
                            ? {
                                right: isDesktopLarge
                                  ? `${heroIllustrationPosition.right}px`
                                  : `${(heroIllustrationPosition.right / 1920) * 100}vw`,
                              }
                            : {}),
                        }
                      : {}),
                  }
                : undefined
            }
          >
            <img src={heroIllustration} alt="모발이식 일러스트" className={styles.heroIllustrationImage} />
          </div>
        </div>
        {/* 모바일 일러스트 - Hero Container 밖에 위치 */}
        <img src={heroIllustrationMobile} alt="모발이식 일러스트" className={styles.heroIllustrationImageMobile} />
      </section>

      {/* Section 1 */}
      <section
        className={styles.section1}
        style={
          isMobile && section1.mobileHeight
            ? {
                minHeight: mvw(section1.mobileHeight),
              }
            : undefined
        }
      >
        <div className={styles.section1Content}>
          {isMobile ? (
            <>
              {/* 모바일: 숫자 → 제목 → 이미지 → 텍스트 순서 */}

              <div className={styles.section1Left}>
                {!scarReduction && <div className={styles.section1Number}>{section1.number}</div>}
                <div className={styles.section1Text}>
                  <h2
                    className={styles.section1Title}
                    style={{
                      ...(isMobile && section1.titleMobileSize
                        ? {
                            width: section1.titleMobileSize.width
                              ? `${(section1.titleMobileSize.width / 375) * 100}vw`
                              : undefined,
                            height: section1.titleMobileSize.height
                              ? `${(section1.titleMobileSize.height / 375) * 100}vw`
                              : undefined,
                          }
                        : {}),
                      ...(section1.titleMarginBottom !== undefined
                        ? {
                            marginBottom: isMobile
                              ? mvw(40) // Always use mvw(40) for mobile
                              : `${(section1.titleMarginBottom / 1920) * 100}vw`,
                          }
                        : {}),
                    }}
                  >
                    {isMobile && section1.titleMobile ? section1.titleMobile : section1.title}
                  </h2>

                  {/* 모바일: 타이틀 아래 메인 이미지 */}
                  {(section1.imagesMobile?.main || section1.images?.main) && (
                    <motion.div
                      className={
                        section1.imagesMobileSize?.mainMaxWidth
                          ? undefined // Don't apply the CSS class if we want 100vw
                          : styles.section1Image1
                      }
                      initial={{ opacity: 0, y: 80 }}
                      animate={{ opacity: 1, y: 0 }}
                      transition={{
                        duration: 0.5,
                        ease: 'easeOut',
                        delay: 0.4,
                      }}
                      style={{
                        ...(section1.imagesMobileSize?.mainMaxWidth
                          ? {
                              position: 'relative',
                              width: '100vw',
                              maxWidth: 'none',
                              height: section1.imagesMobileSize.mainHeight
                                ? mvw(section1.imagesMobileSize.mainHeight)
                                : section1.imagesMobileSize.height
                                ? mvw(section1.imagesMobileSize.height)
                                : 'auto',
                              left: '50%',
                              right: '50%',
                              marginLeft: '-50vw',
                              marginRight: '-50vw',
                              borderRadius: mvw(12),
                              overflow: 'hidden',
                              display: 'block',
                            }
                          : {
                              width: '100%',
                              maxWidth: '100%',
                              height: section1.imagesMobileSize?.mainHeight
                                ? mvw(section1.imagesMobileSize.mainHeight)
                                : section1.imagesMobileSize?.height
                                ? mvw(section1.imagesMobileSize.height)
                                : 'auto',
                            }),
                      }}
                    >
                      <img
                        src={section1.imagesMobile?.main || section1.images?.main}
                        alt="이미지 1"
                        className={styles.section1ImageContent}
                      />
                    </motion.div>
                  )}

                  <div
                    className={styles.section1Description}
                    style={
                      section1.descriptionWidth !== undefined && !isMobile
                        ? {
                            width: isDesktopLarge ? `${section1.descriptionWidth}px` : vw(section1.descriptionWidth),
                            maxWidth: isDesktopLarge ? `${section1.descriptionWidth}px` : vw(section1.descriptionWidth), // maxWidth도 함께 설정
                          }
                        : undefined
                    }
                  >
                    {isMobile && section1.descriptionMobile ? section1.descriptionMobile : section1.description}
                  </div>

                  {/* 모바일 일러스트 - description 아래에 배치 */}
                  {section1.illustrationMobile && (
                    <div
                      className={styles.section1MobileIllustration}
                      style={{
                        ...(section1.illustrationMobileSize
                          ? {
                              // When fullWidth is true, width and margins are handled by CSS
                              ...(section1.illustrationMobileSize.fullWidth
                                ? {
                                    height: section1.illustrationMobileSize.height
                                      ? mvw(section1.illustrationMobileSize.height)
                                      : undefined,
                                    aspectRatio:
                                      section1.illustrationMobileSize.width && section1.illustrationMobileSize.height
                                        ? `${section1.illustrationMobileSize.width} / ${section1.illustrationMobileSize.height}`
                                        : undefined,
                                  }
                                : {
                                    width: section1.illustrationMobileSize.width
                                      ? mvw(section1.illustrationMobileSize.width)
                                      : '100%',
                                    height: section1.illustrationMobileSize.height
                                      ? mvw(section1.illustrationMobileSize.height)
                                      : undefined,
                                    aspectRatio:
                                      section1.illustrationMobileSize.width && section1.illustrationMobileSize.height
                                        ? `${section1.illustrationMobileSize.width} / ${section1.illustrationMobileSize.height}`
                                        : undefined,
                                  }),
                            }
                          : {
                              width: '100%',
                              aspectRatio: '324 / 252',
                            }),
                        ...(section1.illustrationMobileMargin
                          ? {
                              ...(section1.illustrationMobileMargin.top !== undefined
                                ? {
                                    marginTop: mvw(section1.illustrationMobileMargin.top),
                                  }
                                : {}),
                              ...(section1.illustrationMobileMargin.right !== undefined &&
                              !section1.illustrationMobileSize?.fullWidth
                                ? {
                                    marginRight: mvw(section1.illustrationMobileMargin.right),
                                  }
                                : {}),
                              ...(section1.illustrationMobileMargin.bottom !== undefined
                                ? {
                                    marginBottom: mvw(section1.illustrationMobileMargin.bottom),
                                  }
                                : {}),
                              ...(section1.illustrationMobileMargin.left !== undefined &&
                              !section1.illustrationMobileSize?.fullWidth
                                ? {
                                    marginLeft: mvw(section1.illustrationMobileMargin.left),
                                  }
                                : {}),
                            }
                          : {}),
                      }}
                    >
                      <img
                        src={section1.illustrationMobile}
                        alt="일러스트"
                        style={{
                          width: '100%',
                          height: '100%',
                          objectFit: 'contain',
                        }}
                      />
                    </div>
                  )}
                </div>

                {/* 모바일 이미지 (기존) */}
                {section1.mobileImages?.illustration && (
                  <div
                    className={isHairline ? styles.section1ImageHairline : styles.section1Image}
                    style={
                      section1.mobileImages?.illustrationSize
                        ? {
                            width: `${(section1.mobileImages.illustrationSize.width / 375) * 100}vw`,
                            height: `${(section1.mobileImages.illustrationSize.height / 375) * 100}vw`,
                            maxWidth: '100%',
                          }
                        : undefined
                    }
                  >
                    <img
                      src={section1.mobileImages.illustration as string}
                      alt="일러스트"
                      className={styles.section1Illustration}
                    />
                  </div>
                )}

                {/* 모바일: 일러스트 아래 보조 이미지 */}
                {(section1.imagesMobile?.secondary || section1.images?.secondary) && (
                  <motion.div
                    className={
                      section1.imagesMobileSize?.secondaryMaxWidth
                        ? undefined // Don't apply the CSS class if we want 100vw
                        : styles.section1Image2
                    }
                    initial={{ opacity: 0, y: 80 }}
                    animate={{ opacity: 1, y: 0 }}
                    transition={{ duration: 0.5, ease: 'easeOut', delay: 0.8 }}
                    style={{
                      ...(section1.imagesMobileSize?.secondaryMaxWidth
                        ? {
                            // position: "relative",
                            width: '100vw',
                            maxWidth: '100vw',
                            height: section1.imagesMobileSize.secondaryHeight
                              ? mvw(section1.imagesMobileSize.secondaryHeight)
                              : section1.imagesMobileSize.height
                              ? mvw(section1.imagesMobileSize.height)
                              : 'auto',
                          }
                        : {
                            width: '100%',
                            maxWidth: '100%',
                            height: section1.imagesMobileSize?.secondaryHeight
                              ? mvw(section1.imagesMobileSize.secondaryHeight)
                              : section1.imagesMobileSize?.height
                              ? mvw(section1.imagesMobileSize.height)
                              : 'auto',
                          }),
                    }}
                  >
                    <img
                      src={section1.imagesMobile?.secondary || section1.images?.secondary}
                      alt="이미지 2"
                      className={styles.section1ImageContent}
                    />
                  </motion.div>
                )}
              </div>
            </>
          ) : (
            <>
              <div className={styles.section1Left}>
                {!scarReduction && <div className={styles.section1Number}>{section1.number}</div>}
                <div
                  className={styles.section1Text}
                  style={{
                    ...(section1.section1RightSize?.height && !isMobile
                      ? {
                          height: isDesktopLarge
                            ? `${section1.section1RightSize.height}px`
                            : `${section1.section1RightSize.height / 19.2}vw`,
                        }
                      : {}),
                  }}
                >
                  <h2
                    className={styles.section1Title}
                    style={{
                      ...(isMobile && section1.titleMobileSize
                        ? {
                            width: section1.titleMobileSize.width
                              ? `${(section1.titleMobileSize.width / 375) * 100}vw`
                              : undefined,
                            height: section1.titleMobileSize.height
                              ? `${(section1.titleMobileSize.height / 375) * 100}vw`
                              : undefined,
                          }
                        : {}),
                      ...(section1.titleMarginBottom !== undefined
                        ? {
                            marginBottom: isMobile
                              ? mvw(40) // Always use mvw(40) for mobile
                              : `${(section1.titleMarginBottom / 1920) * 100}vw`,
                          }
                        : {}),
                      // 일러스트가 있을 때는 marginBottom 제거 (space-between으로 배치)
                      ...(section1.illustration && !isMobile
                        ? {
                            marginBottom: '0',
                          }
                        : {}),
                    }}
                  >
                    {isMobile && section1.titleMobile ? section1.titleMobile : section1.title}
                  </h2>
                  {section1.illustration && (
                    <div className={isHairline ? styles.section1ImageHairline : styles.section1Image}>
                      <img
                        src={section1.illustration}
                        alt="일러스트"
                        className={styles.section1Illustration}
                        style={
                          section1.illustrationSize
                            ? {
                                width: isDesktopLarge
                                  ? `${section1.illustrationSize.width}px`
                                  : `${section1.illustrationSize.width / 19.2}vw`,
                                height: isDesktopLarge
                                  ? `${section1.illustrationSize.height}px`
                                  : `${section1.illustrationSize.height / 19.2}vw`,
                              }
                            : undefined
                        }
                      />
                    </div>
                  )}
                  <div
                    className={styles.section1Description}
                    style={
                      section1.descriptionWidth !== undefined && !isMobile
                        ? {
                            width: isDesktopLarge ? `${section1.descriptionWidth}px` : vw(section1.descriptionWidth),
                            maxWidth: isDesktopLarge ? `${section1.descriptionWidth}px` : vw(section1.descriptionWidth), // maxWidth도 함께 설정
                          }
                        : undefined
                    }
                  >
                    {isMobile && section1.descriptionMobile ? section1.descriptionMobile : section1.description}
                  </div>
                </div>
              </div>
              <div
                className={styles.section1Right}
                ref={section1ImagesRef}
                style={
                  section1.section1RightSize
                    ? {
                        ...(section1.section1RightSize.width !== undefined
                          ? {
                              width: isDesktopLarge
                                ? `${section1.section1RightSize.width}px`
                                : vw(section1.section1RightSize.width),
                              maxWidth: isDesktopLarge
                                ? `${section1.section1RightSize.width}px`
                                : vw(section1.section1RightSize.width), // maxWidth도 함께 설정
                            }
                          : {}),
                        ...(section1.section1RightSize.height !== undefined
                          ? {
                              height: isDesktopLarge
                                ? `${section1.section1RightSize.height}px`
                                : vw(section1.section1RightSize.height),
                              minHeight: isDesktopLarge
                                ? `${section1.section1RightSize.height}px`
                                : vw(section1.section1RightSize.height), // minHeight도 함께 설정
                            }
                          : {}),
                      }
                    : undefined
                }
              >
                {/* Use mobile images if available on mobile, otherwise use regular images */}
                {(isMobile && section1.imagesMobile?.main ? section1.imagesMobile.main : section1.images?.main) && (
                  <motion.div
                    className={styles.section1Image1}
                    initial={{ opacity: 0, y: 80 }}
                    animate={section1ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                    transition={{ duration: 0.5, ease: 'easeOut', delay: 0.4 }}
                    style={
                      isMobile && section1.imagesMobileSize
                        ? {
                            width: section1.imagesMobileSize.mainMaxWidth ? '100vw' : '100%',
                            maxWidth: section1.imagesMobileSize.mainMaxWidth ? '100vw' : '100%',
                            height: section1.imagesMobileSize.mainHeight
                              ? mvw(section1.imagesMobileSize.mainHeight)
                              : section1.imagesMobileSize.height
                              ? mvw(section1.imagesMobileSize.height)
                              : 'auto',
                            marginLeft: section1.imagesMobileSize.mainMaxWidth ? mvw(-20) : undefined,
                            marginRight: section1.imagesMobileSize.mainMaxWidth ? mvw(-20) : undefined,
                          }
                        : {
                            ...(section1.imagesSize?.main
                              ? {
                                  width: isDesktopLarge
                                    ? `${section1.imagesSize.main.width}px`
                                    : vw(section1.imagesSize.main.width),
                                  height: isDesktopLarge
                                    ? `${section1.imagesSize.main.height}px`
                                    : vw(section1.imagesSize.main.height),
                                  maxWidth: isDesktopLarge
                                    ? `${section1.imagesSize.main.width}px`
                                    : vw(section1.imagesSize.main.width),
                                }
                              : {}),
                            ...(section1.imagesPosition?.main
                              ? {
                                  position: 'absolute' as const,
                                  ...(section1.imagesPosition.main.top !== undefined
                                    ? {
                                        top: isDesktopLarge
                                          ? `${section1.imagesPosition.main.top}px`
                                          : vw(section1.imagesPosition.main.top),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.main.right !== undefined
                                    ? {
                                        right: isDesktopLarge
                                          ? `${section1.imagesPosition.main.right}px`
                                          : vw(section1.imagesPosition.main.right),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.main.bottom !== undefined
                                    ? {
                                        bottom: isDesktopLarge
                                          ? `${section1.imagesPosition.main.bottom}px`
                                          : vw(section1.imagesPosition.main.bottom),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.main.left !== undefined
                                    ? {
                                        left: isDesktopLarge
                                          ? `${section1.imagesPosition.main.left}px`
                                          : vw(section1.imagesPosition.main.left),
                                      }
                                    : {}),
                                }
                              : {}),
                          }
                    }
                  >
                    <img
                      src={isMobile && section1.imagesMobile?.main ? section1.imagesMobile.main : section1.images?.main}
                      alt="이미지 1"
                      className={styles.section1ImageContent}
                    />
                  </motion.div>
                )}
                {(isMobile && section1.imagesMobile?.secondary
                  ? section1.imagesMobile.secondary
                  : section1.images?.secondary) && (
                  <motion.div
                    className={styles.section1Image2}
                    initial={{ opacity: 0, y: 80 }}
                    animate={section1ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                    transition={{ duration: 0.5, ease: 'easeOut', delay: 0.8 }}
                    style={
                      isMobile && section1.imagesMobileSize
                        ? {
                            width: section1.imagesMobileSize.secondaryMaxWidth ? '100vw' : '100%',
                            maxWidth: section1.imagesMobileSize.secondaryMaxWidth ? '100vw' : '100%',
                            height: section1.imagesMobileSize.secondaryHeight
                              ? mvw(section1.imagesMobileSize.secondaryHeight)
                              : section1.imagesMobileSize.height
                              ? mvw(section1.imagesMobileSize.height)
                              : 'auto',
                            marginLeft: section1.imagesMobileSize.secondaryMaxWidth ? mvw(-20) : undefined,
                            marginRight: section1.imagesMobileSize.secondaryMaxWidth ? mvw(-20) : undefined,
                          }
                        : {
                            ...(section1.imagesSize?.secondary
                              ? {
                                  width: isDesktopLarge
                                    ? `${section1.imagesSize.secondary.width}px`
                                    : vw(section1.imagesSize.secondary.width),
                                  height: isDesktopLarge
                                    ? `${section1.imagesSize.secondary.height}px`
                                    : vw(section1.imagesSize.secondary.height),
                                  maxWidth: isDesktopLarge
                                    ? `${section1.imagesSize.secondary.width}px`
                                    : vw(section1.imagesSize.secondary.width),
                                }
                              : {}),
                            ...(section1.imagesPosition?.secondary
                              ? {
                                  position: 'absolute' as const,
                                  ...(section1.imagesPosition.secondary.top !== undefined
                                    ? {
                                        top: isDesktopLarge
                                          ? `${section1.imagesPosition.secondary.top}px`
                                          : vw(section1.imagesPosition.secondary.top),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.secondary.right !== undefined
                                    ? {
                                        right: isDesktopLarge
                                          ? `${section1.imagesPosition.secondary.right}px`
                                          : vw(section1.imagesPosition.secondary.right),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.secondary.bottom !== undefined
                                    ? {
                                        bottom: isDesktopLarge
                                          ? `${section1.imagesPosition.secondary.bottom}px`
                                          : vw(section1.imagesPosition.secondary.bottom),
                                      }
                                    : {}),
                                  ...(section1.imagesPosition.secondary.left !== undefined
                                    ? {
                                        left: isDesktopLarge
                                          ? `${section1.imagesPosition.secondary.left}px`
                                          : vw(section1.imagesPosition.secondary.left),
                                      }
                                    : {}),
                                }
                              : {}),
                          }
                    }
                  >
                    <img
                      src={
                        isMobile && section1.imagesMobile?.secondary
                          ? section1.imagesMobile.secondary
                          : section1.images?.secondary
                      }
                      alt="이미지 2"
                      className={styles.section1ImageContent2}
                    />
                  </motion.div>
                )}
              </div>
            </>
          )}
        </div>
      </section>

      {/* Custom Middle Section (for ProcessSection in scarReduction) */}
      {customMiddleSection}

      {/* Section 2 */}
      <Section2
        section2={section2}
        isMobile={isMobile}
        isDesktopLarge={isDesktopLarge}
        scarReduction={scarReduction}
        isCrown={isCrown}
        language={language}
        processDescription={processDescription}
      />

      {/* Section 3 - Only render if not scarReduction and section3 exists */}
      {!scarReduction && section3 && (
        <Section3 section3={section3} isMobile={isMobile} isDesktopLarge={isDesktopLarge} scarReduction={scarReduction} />
      )}

              <>
                {/* 모바일: 제목 → 이미지 → 설명 순서 */}
                {!scarReduction && section3.number && (
                  <div
                    className={styles.section3Number}
                    style={
                      section3.numberPosition
                        ? {
                            position: 'absolute',
                            ...(() => {
                              const numberPos = section3.numberPosition as any;
                              const position = isMobile
                                ? numberPos.mobile || numberPos
                                : numberPos.desktop || numberPos;

                              return position.top !== undefined
                                ? {
                                    top: isMobile
                                      ? mvw(position.top * 0.2)
                                      : isDesktopLarge
                                      ? `${position.top}px`
                                      : vw(position.top),
                                  }
                                : {};
                            })(),
                            ...(() => {
                              const numberPos = section3.numberPosition as any;
                              const position = isMobile
                                ? numberPos.mobile || numberPos
                                : numberPos.desktop || numberPos;

                              return position.right !== undefined
                                ? {
                                    right: isMobile
                                      ? mvw(position.right * 0.2)
                                      : isDesktopLarge
                                      ? `${position.right}px`
                                      : vw(position.right),
                                  }
                                : {};
                            })(),
                          }
                        : undefined
                    }
                  >
                    {section3.number}
                  </div>
                )}
                <div className={styles.section3Left}>
                  <div className={styles.section3Text}>
                    <h2
                      className={styles.section3Title}
                      style={{
                        ...(isMobile && section3.titleMobileSize
                          ? {
                              width: section3.titleMobileSize?.width
                                ? `${(section3.titleMobileSize.width / 375) * 100}vw`
                                : undefined,
                              height: section3.titleMobileSize?.height
                                ? `${(section3.titleMobileSize.height / 375) * 100}vw`
                                : undefined,
                            }
                          : {}),
                        ...(section3.titleMarginBottom !== undefined
                          ? {
                              marginBottom: isMobile
                                ? mvw(40) // Always use mvw(40) for mobile
                                : `${(section3.titleMarginBottom / 1920) * 100}vw`,
                            }
                          : {}),
                      }}
                    >
                      {isMobile && section3.titleMobile
                        ? typeof section3.titleMobile === 'string'
                          ? (() => {
                              const titleText = section3.titleMobile as string;
                              const lines = titleText.split('\n');
                              return lines.map((line, index) => (
                                <span key={index}>
                                  {line}
                                  {index < lines.length - 1 && <br />}
                                </span>
                              ));
                            })()
                          : section3.titleMobile
                        : section3.title}
                    </h2>
                    {(section3.imagesMobile?.main || section3.images?.main) && (
                      <motion.div
                        className={styles.section3Image}
                        initial={{ opacity: 0, y: 80 }}
                        animate={{ opacity: 1, y: 0 }}
                        transition={{
                          duration: 0.5,
                          ease: 'easeOut',
                          delay: 0.8,
                        }}
                      >
                        <img
                          src={section3.imagesMobile?.main || section3.images?.main}
                          alt="이미지"
                          className={styles.section3ImageContent}
                        />
                      </motion.div>
                    )}

                    <div className={styles.section3Description}>
                      {isMobile && section3.descriptionMobile ? section3.descriptionMobile : section3.description}
                    </div>

                    {/* 모바일 일러스트레이션 - description 아래로 이동 */}
                    {section3.illustrationMobile && (
                      <div
                        className={styles.section3MobileIllustration}
                        style={{
                          width: '100vw',
                          marginLeft: mvw(-16), // 부모의 패딩 상쇄
                          marginRight: mvw(-16), // 부모의 패딩 상쇄
                          height: section3.illustrationMobileSize?.height
                            ? mvw(section3.illustrationMobileSize.height)
                            : undefined,
                          aspectRatio:
                            section3.illustrationMobileSize?.width && section3.illustrationMobileSize?.height
                              ? `${section3.illustrationMobileSize.width} / ${section3.illustrationMobileSize.height}`
                              : '375 / 336',
                        }}
                      >
                        <img
                          src={section3.illustrationMobile}
                          alt="일러스트"
                          style={{
                            objectFit: 'contain',
                          }}
                        />
                      </div>
                    )}
                  </div>
                </div>
              </>
            ) : (
              <>
                {/* illustration이 있으면 absolute이거나 일반 배치 */}
                {section3.illustration && section3.illustrationPosition ? (
                  // Absolute positioning일 때는 일반 레이아웃 사용 (왼쪽 텍스트/오른쪽 이미지)
                  <>
                    <div className={styles.section3Left}>
                      {!scarReduction && (
                        <div
                          className={styles.section3Number}
                          style={
                            section3.numberPosition
                              ? {
                                  position: 'absolute',
                                  ...(() => {
                                    const numberPos = section3.numberPosition as any;
                                    const position = isMobile
                                      ? numberPos.mobile || numberPos
                                      : numberPos.desktop || numberPos;

                                    return position.top !== undefined
                                      ? {
                                          top: isDesktopLarge
                                            ? `${position.top}px`
                                            : isMobile
                                            ? mvw(position.top * 0.2)
                                            : vw(position.top),
                                        }
                                      : {};
                                  })(),
                                  ...(() => {
                                    const numberPos = section3.numberPosition as any;
                                    const position = isMobile
                                      ? numberPos.mobile || numberPos
                                      : numberPos.desktop || numberPos;

                                    const result: any = {};

                                    if (position.right !== undefined) {
                                      result.right = isDesktopLarge
                                        ? `${position.right}px`
                                        : isMobile
                                        ? mvw(position.right * 0.2)
                                        : vw(position.right);
                                    }

                                    if (position.bottom !== undefined) {
                                      result.bottom = isDesktopLarge
                                        ? `${position.bottom}px`
                                        : isMobile
                                        ? mvw(position.bottom * 0.2)
                                        : vw(position.bottom);
                                    }

                                    if (position.left !== undefined) {
                                      result.left = isDesktopLarge
                                        ? `${position.left}px`
                                        : isMobile
                                        ? mvw(position.left * 0.2)
                                        : vw(position.left);
                                    }

                                    return result;
                                  })(),
                                }
                              : undefined
                          }
                        >
                          {section3.number}
                        </div>
                      )}
                      <div className={styles.section3Text}>
                        <h2
                          className={styles.section3Title}
                          style={
                            section3.titleMarginBottom !== undefined
                              ? {
                                  marginBottom: isMobile
                                    ? mvw(40) // Always use mvw(40) for mobile
                                    : `${(section3.titleMarginBottom / 1920) * 100}vw`,
                                }
                              : undefined
                          }
                        >
                          {isMobile && section3.titleMobile
                            ? typeof section3.titleMobile === 'string'
                              ? (() => {
                                  const titleText = section3.titleMobile as string;
                                  const lines = titleText.split('\n');
                                  return lines.map((line, index) => (
                                    <span key={index}>
                                      {line}
                                      {index < lines.length - 1 && <br />}
                                    </span>
                                  ));
                                })()
                              : section3.titleMobile
                            : section3.title}
                        </h2>
                        <div className={styles.section3Description}>
                          {isMobile && section3.descriptionMobile ? section3.descriptionMobile : section3.description}
                        </div>
                      </div>
                    </div>
                    <div className={styles.section3Right} ref={section3ImagesRef}>
                      {section3.images?.main && (
                        <motion.div
                          className={styles.section3Image}
                          initial={{ opacity: 0, y: 80 }}
                          animate={section3ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                          transition={{ duration: 0.5, ease: 'easeOut' }}
                          style={
                            section3.imagesSize?.main
                              ? {
                                  width: isDesktopLarge
                                    ? `${section3.imagesSize.main.width}px`
                                    : vw(section3.imagesSize.main.width),
                                  height: isDesktopLarge
                                    ? `${section3.imagesSize.main.height}px`
                                    : vw(section3.imagesSize.main.height),
                                }
                              : undefined
                          }
                        >
                          <img src={section3.images.main} alt="이미지" className={styles.section3ImageContent} />
                        </motion.div>
                      )}
                    </div>
                    {/* Absolute positioned illustration */}
                    <div
                      className={styles.section3DesktopIllustration}
                      style={{
                        position: 'absolute' as const,
                        top: section3.illustrationPosition.top
                          ? isDesktopLarge
                            ? `${section3.illustrationPosition.top}px`
                            : vw(section3.illustrationPosition.top)
                          : undefined,
                        right: section3.illustrationPosition.right
                          ? isDesktopLarge
                            ? `${section3.illustrationPosition.right}px`
                            : vw(section3.illustrationPosition.right)
                          : undefined,
                        bottom: section3.illustrationPosition.bottom
                          ? isDesktopLarge
                            ? `${section3.illustrationPosition.bottom}px`
                            : vw(section3.illustrationPosition.bottom)
                          : undefined,
                        left: section3.illustrationPosition.left
                          ? isDesktopLarge
                            ? `${section3.illustrationPosition.left}px`
                            : vw(section3.illustrationPosition.left)
                          : undefined,
                        width: section3.illustrationSize
                          ? isDesktopLarge
                            ? `${section3.illustrationSize.width}px`
                            : vw(section3.illustrationSize.width)
                          : 'auto',
                        height: section3.illustrationSize
                          ? isDesktopLarge
                            ? `${section3.illustrationSize.height}px`
                            : vw(section3.illustrationSize.height)
                          : 'auto',
                        zIndex: 2,
                      }}
                    >
                      <img
                        src={section3.illustration}
                        alt="일러스트"
                        style={{
                          width: '100%',
                          height: '100%',
                          objectFit: 'contain',
                        }}
                      />
                    </div>
                  </>
                ) : section3.illustration ? (
                  // 일반 illustration 배치 (기존 코드)
                  <>
                    <div className={styles.section3RightWithSvg} ref={section3ImagesRef}>
                      <div className={styles.section3Text}>
                        {!scarReduction && (
                          <div
                            className={styles.section3Number}
                            style={
                              section3.numberPosition
                                ? {
                                    position: 'absolute',
                                    // Desktop positioning
                                    ...(section3.numberPosition.desktop?.top !== undefined
                                      ? {
                                          top: isDesktopLarge
                                            ? `${section3.numberPosition.desktop.top}px`
                                            : vw(section3.numberPosition.desktop.top),
                                        }
                                      : {}),
                                    ...(section3.numberPosition.desktop?.right !== undefined
                                      ? {
                                          right: isDesktopLarge
                                            ? `${section3.numberPosition.desktop.right}px`
                                            : vw(section3.numberPosition.desktop.right),
                                        }
                                      : {}),
                                    ...(section3.numberPosition.desktop?.bottom !== undefined
                                      ? {
                                          bottom: isDesktopLarge
                                            ? `${section3.numberPosition.desktop.bottom}px`
                                            : vw(section3.numberPosition.desktop.bottom),
                                        }
                                      : {}),
                                    ...(section3.numberPosition.desktop?.left !== undefined
                                      ? {
                                          left: isDesktopLarge
                                            ? `${section3.numberPosition.desktop.left}px`
                                            : vw(section3.numberPosition.desktop.left),
                                        }
                                      : {}),
                                  }
                                : undefined
                            }
                          >
                            {section3.number}
                          </div>
                        )}
                        <h2
                          className={styles.section3Title}
                          style={
                            isMobile && section3.titleMobileSize
                              ? {
                                  width: section3.titleMobileSize?.width
                                    ? `${(section3.titleMobileSize.width / 375) * 100}vw`
                                    : undefined,
                                  height: section3.titleMobileSize?.height
                                    ? `${(section3.titleMobileSize.height / 375) * 100}vw`
                                    : undefined,
                                }
                              : undefined
                          }
                        >
                          {isMobile && section3.titleMobile
                            ? typeof section3.titleMobile === 'string'
                              ? (() => {
                                  const titleText = section3.titleMobile as string;
                                  const lines = titleText.split('\n');
                                  return lines.map((line, index) => (
                                    <span key={index}>
                                      {line}
                                      {index < lines.length - 1 && <br />}
                                    </span>
                                  ));
                                })()
                              : section3.titleMobile
                            : section3.title}
                        </h2>
                        <div className={styles.section3CenterIllustrationWithSvg}>
                          <img
                            src={section3.illustration}
                            alt="일러스트"
                            className={styles.section3CenterIllustrationImage}
                            style={
                              section3.illustrationSize
                                ? {
                                    width: isDesktopLarge
                                      ? `${section3.illustrationSize.width}px`
                                      : `${section3.illustrationSize.width / 19.2}vw`,
                                    height: isDesktopLarge
                                      ? `${section3.illustrationSize.height}px`
                                      : `${section3.illustrationSize.height / 19.2}vw`,
                                  }
                                : undefined
                            }
                          />
                          <div>
                            <div className={styles.section3Description}>
                              {isMobile && section3.descriptionMobile
                                ? section3.descriptionMobile
                                : section3.description}
                            </div>
                          </div>
                        </div>
                      </div>
                      {section3.images?.main && (
                        <motion.div
                          className={styles.section3Image}
                          initial={{ opacity: 0, y: 80 }}
                          animate={section3ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                          transition={{
                            duration: 0.5,
                            ease: 'easeOut',
                            delay: 0.2,
                          }}
                          style={
                            section3.imagesSize?.main
                              ? {
                                  width: isDesktopLarge
                                    ? `${section3.imagesSize.main.width}px`
                                    : vw(section3.imagesSize.main.width),
                                  height: isDesktopLarge
                                    ? `${section3.imagesSize.main.height}px`
                                    : vw(section3.imagesSize.main.height),
                                }
                              : undefined
                          }
                        >
                          <img src={section3.images.main} alt="이미지" className={styles.section3ImageContent} />
                        </motion.div>
                      )}
                    </div>
                  </>
                ) : (
                  <>
                    {/* illustration이 없으면 기존 레이아웃 - scarReduction일 때는 순서 바꾸기 */}
                    {scarReduction ? (
                      <>
                        {/* scarReduction: 왼쪽 이미지, 오른쪽 텍스트 */}
                        <div className={styles.section3Right} ref={section3ImagesRef}>
                          {section3.images?.main && (
                            <motion.div
                              className={styles.section3Image}
                              initial={{ opacity: 0, y: 80 }}
                              animate={section3ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                              transition={{ duration: 0.5, ease: 'easeOut' }}
                              style={
                                section3.imagesSize?.main
                                  ? {
                                      width: isDesktopLarge
                                        ? `${section3.imagesSize.main.width}px`
                                        : vw(section3.imagesSize.main.width),
                                      height: isDesktopLarge
                                        ? `${section3.imagesSize.main.height}px`
                                        : vw(section3.imagesSize.main.height),
                                    }
                                  : undefined
                              }
                            >
                              <img src={section3.images.main} alt="이미지" className={styles.section3ImageContent} />
                            </motion.div>
                          )}
                        </div>
                        <div className={styles.section3Left}>
                          <div className={styles.section3Text}>
                            <h2 className={styles.section3Title}>
                              {isMobile && section3.titleMobile
                                ? typeof section3.titleMobile === 'string'
                                  ? (() => {
                                      const titleText = section3.titleMobile as string;
                                      const lines = titleText.split('\n');
                                      return lines.map((line, index) => (
                                        <span key={index}>
                                          {line}
                                          {index < lines.length - 1 && <br />}
                                        </span>
                                      ));
                                    })()
                                  : section3.titleMobile
                                : section3.title}
                            </h2>
                            <div className={styles.section3Description}>{section3.description}</div>
                          </div>
                        </div>
                      </>
                    ) : (
                      <>
                        {/* 기본: 왼쪽 텍스트, 오른쪽 이미지 */}
                        <div className={styles.section3Left}>
                          <div className={styles.section3Text}>
                            {!scarReduction && (
                              <div
                                className={styles.section3Number}
                                style={
                                  section3.numberPosition
                                    ? {
                                        position: 'absolute',
                                        ...(() => {
                                          const numberPos = section3.numberPosition as any;
                                          const position = isMobile
                                            ? numberPos.mobile || numberPos
                                            : numberPos.desktop || numberPos;

                                          return position.top !== undefined
                                            ? {
                                                top: isMobile
                                                  ? mvw(position.top * 0.2)
                                                  : isDesktopLarge
                                                  ? `${position.top}px`
                                                  : vw(position.top),
                                              }
                                            : {};
                                        })(),
                                        ...(() => {
                                          const numberPos = section3.numberPosition as any;
                                          const position = isMobile
                                            ? numberPos.mobile || numberPos
                                            : numberPos.desktop || numberPos;

                                          const result: any = {};

                                          if (position.right !== undefined) {
                                            result.right = isDesktopLarge
                                              ? `${position.right}px`
                                              : isMobile
                                              ? mvw(position.right * 0.2)
                                              : vw(position.right);
                                          }

                                          if (position.bottom !== undefined) {
                                            result.bottom = isDesktopLarge
                                              ? `${position.bottom}px`
                                              : isMobile
                                              ? mvw(position.bottom * 0.2)
                                              : vw(position.bottom);
                                          }

                                          if (position.left !== undefined) {
                                            result.left = isDesktopLarge
                                              ? `${position.left}px`
                                              : isMobile
                                              ? mvw(position.left * 0.2)
                                              : vw(position.left);
                                          }

                                          return result;
                                        })(),
                                      }
                                    : undefined
                                }
                              >
                                {section3.number}
                              </div>
                            )}
                            <h2
                              className={styles.section3Title}
                              style={
                                isMobile && section3.titleMobileSize
                                  ? {
                                      width: section3.titleMobileSize?.width
                                        ? `${(section3.titleMobileSize.width / 375) * 100}vw`
                                        : undefined,
                                      height: section3.titleMobileSize?.height
                                        ? `${(section3.titleMobileSize.height / 375) * 100}vw`
                                        : undefined,
                                    }
                                  : undefined
                              }
                            >
                              {isMobile && section3.titleMobile
                                ? typeof section3.titleMobile === 'string'
                                  ? (() => {
                                      const titleText = section3.titleMobile as string;
                                      const lines = titleText.split('\n');
                                      return lines.map((line, index) => (
                                        <span key={index}>
                                          {line}
                                          {index < lines.length - 1 && <br />}
                                        </span>
                                      ));
                                    })()
                                  : section3.titleMobile
                                : section3.title}
                            </h2>
                            <div className={styles.section3Description}>{section3.description}</div>
                          </div>
                        </div>
                        <div className={styles.section3Right} ref={section3ImagesRef}>
                          {section3.images?.main && (
                            <motion.div
                              className={styles.section3Image}
                              initial={{ opacity: 0, y: 80 }}
                              animate={section3ImagesInView ? { opacity: 1, y: 0 } : { opacity: 0, y: 80 }}
                              transition={{ duration: 0.5, ease: 'easeOut' }}
                              style={
                                section3.imagesSize?.main
                                  ? {
                                      width: isDesktopLarge
                                        ? `${section3.imagesSize.main.width}px`
                                        : vw(section3.imagesSize.main.width),
                                      height: isDesktopLarge
                                        ? `${section3.imagesSize.main.height}px`
                                        : vw(section3.imagesSize.main.height),
                                    }
                                  : undefined
                              }
                            >
                              <img src={section3.images.main} alt="이미지" className={styles.section3ImageContent} />
                            </motion.div>
                          )}
                        </div>
                      </>
                    )}
                  </>
                )}
              </>
            )}
          </div>
        </section>
      )}

      {/* Before & After Section */}
      <section className={styles.beforeAfterSection}>
        <div className={styles.beforeAfterContent}>
          <div className={styles.beforeAfterHeader}>
            <div className={styles.beforeAfterCategory}>{beforeAfterData.category}</div>
            <div className={styles.beforeAfterTitle}>{beforeAfterData.title}</div>
          </div>
          <div className={styles.beforeAfterSliderWrapper}>
            <BeforeAfterSlider
              beforeImage={beforeAfterData.beforeImage}
              afterImage={beforeAfterData.afterImage}
              beforeAlt={beforeAfterData.beforeAlt}
              afterAlt={beforeAfterData.afterAlt}
              className={styles.beforeAfterSlider}
            />
          </div>
          {beforeAfterButton && (
            <div className={styles.beforeAfterActions}>
              <Link href={beforeAfterButton.href || '/before-after'} className={styles.beforeAfterLink}>
                {isMobile ? (
                  <div style={{ fontSize: mvw(16) }}>
                    <ArrowButton
                      variant="primary"
                      color="blue"
                      size="medium"
                      textAlign="center"
                      width={mvw(224)}
                      height={mvw(44)}
                    >
                      {beforeAfterButton.text}
                    </ArrowButton>
                  </div>
                ) : (
                  <ArrowButton
                    variant="primary"
                    color="blue"
                    size="medium"
                    height={66}
                    paddingTop={12}
                    paddingBottom={10}
                    paddingRight={10}
                    paddingLeft={language === 'JP' ? 35 : 28}
                    fontSize={24}
                    iconSize={44}
                    width={language === 'JP' ? 352 : beforeAfterButton.width || 224}
                    textAlign="left"
                  >
                    {beforeAfterButton.text}
                  </ArrowButton>
                )}
              </Link>
            </div>
          )}
        </div>
      </section>

      {/* Features Section (Optional) */}
      {featuresTitle && featureCards && (
        <FeaturesSection
          featuresTitle={featuresTitle}
          featuresTitleMobile={featuresTitleMobile}
          featureCards={featureCards}
          isMobile={isMobile}
        />
      )}
    </>
  );
}
